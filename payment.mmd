sequenceDiagram
    actor Traveler
    participant System
    participant Booking
    participant Residencebooking
    participant Vehiclebooking
    participant Activitybooking
    participant User
    participant Promotion
    participant Coupon
    participant Bank
    participant Payment

    autonumber

    Traveler ->>+ System : request_payment(user_id, booking_id)

    System ->>+ Booking : get_booking_item(user_id, booking_id)
    
    loop residence items
        Booking ->>+ Residencebooking : get_detail(residence_id)
        Residencebooking -->>- Booking : item
    end

    loop vehicle items
        Booking ->>+ Vehiclebooking : get_detail(vehicle_id)
        Vehiclebooking -->>- Booking : item
    end

    loop activity items
        Booking ->>+ Activitybooking : get_detail(activity_id)
        Activitybooking -->>- Booking : item
    end

    Booking -->>- System : item_list, base_price

    System ->>+ Promotion : get_valid_promotion(base_price)
    Promotion -->>- System : promotion_discount

    System ->>+ User : calculate_membership(user_id)
    User -->>- System : membership_discount

    System ->>+ User : get_coupon_list(user_id)
    User -->>- System : coupon_list

    loop validate coupon
        System ->>+ Coupon : validate_coupon(coupon_code)
        Coupon -->>- System : coupon_discount
    end

    System -->> Traveler : display(list_coupon)
    Traveler ->> System : select_coupon(coupon_code)

    System ->>+ Payment : calculate_price(base_price, promotion_discount, membership_discount, coupon_discount)
    Payment -->>- System : final_price

    System -->> Traveler : show_booking_summary(item_list, final_price)

    Traveler ->> System : submit_slip_number(slip_no)

    System ->>+ Bank : verify_transfer(slip_no)
    Bank -->>- System : result

    alt transfer success
        System ->>+ Booking : update_status_payment("deposit_paid")
        Booking -->>- System : payment_updated

        System ->> Residencebooking : update_status("reserved")
        System ->> Vehiclebooking : update_status("reserved")
        System ->> Activitybooking : update_status("reserved")

        System ->>+ Payment : generate_receipt(item_list, final_price)
        Payment -->>- System : receipt

        System -->> Traveler : payment_success(receipt)
    else transfer failed
        System -->> Traveler : payment_failed()
    end

    System -->>- Traveler : done